<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Travian Planner 8.6</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Vollkorn:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #f3f0e8;
            --container-bg: #fdfbf5;
            --primary-text: #4a2d1e;
            --accent-green: #859f51;
            --accent-blue: #1e88e5; 
            --accent-orange: #fb8c00;
            --border-color: #c9b7a2;
            --table-head-bg: #efebe2;
            --row-alt: #f8f5ee;
            --card-bg: #ffffff;
        }

        html { scroll-behavior: smooth; }

        body {
            font-family: 'Vollkorn', serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 20px;
            font-size: 16px;
            line-height: 1.5;
        }

        .container {
            max-width: 1350px;
            margin: 0 auto;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            color: #6a4b39;
            border-bottom: 2px solid #e0d6c5;
            padding-bottom: 15px;
            margin-top: 0;
            text-align: center;
        }

        /* --- TABS SYSTEM --- */
        .nav-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            border-bottom: 2px solid #c9b7a2;
        }
        .nav-tab {
            padding: 12px 25px;
            background: #e0d6c5;
            border: 1px solid #c9b7a2;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-weight: bold;
            color: #5a4030;
            opacity: 0.7;
            transition: all 0.2s;
        }
        .nav-tab:hover { opacity: 1; background: #d7cbb5; }
        .nav-tab.active {
            background: var(--container-bg);
            opacity: 1;
            border-bottom: 2px solid var(--container-bg);
            margin-bottom: -2px; 
            color: var(--primary-text);
        }

        /* --- VIEWS --- */
        .view-section { display: none; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Controls --- */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-section {
            background-color: var(--card-bg);
            border: 1px solid #e0d6c5;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
        }
        
        .control-section.var-a { border-top: 4px solid var(--accent-green); }
        .control-section.var-b { border-top: 4px solid var(--accent-blue); }
        .control-section.var-c { border-top: 4px solid var(--accent-orange); }

        .section-title {
            font-family: 'Vollkorn', serif;
            font-weight: 700;
            font-size: 1rem;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 12px;
            margin-top: 0;
        }

        .control-group { display: flex; flex-direction: column; margin-bottom: 12px; }
        .control-group:last-child { margin-bottom: 0; }
        
        .control-group label {
            display: block;
            font-weight: 700;
            margin-bottom: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 0.8rem;
            color: #777;
            text-transform: uppercase;
        }

        .control-group select {
            width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px;
            background-color: #fff; color: #333; font-size: 0.9rem;
            font-family: 'Roboto', sans-serif; box-sizing: border-box;
        }

        .range-wrapper { display: flex; align-items: center; gap: 10px; }
        .range-wrapper input[type=range] { flex: 1; accent-color: var(--accent-green); cursor: pointer; height: 5px; }
        .range-value {
            font-family: 'Roboto', sans-serif; font-weight: bold; font-size: 1rem;
            color: var(--primary-text); min-width: 25px; text-align: right;
        }

        /* Weights Row */
        .weights-row {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .weight-item { flex: 1; text-align: center; }
        .weight-item label { font-size: 0.7rem; margin-bottom: 2px; }
        .weight-item input { width: 100%; }
        .weight-val { font-size: 0.8rem; font-weight: bold; display: block; }

        /* Checkbox Grid */
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 12px;
        }
        .checkbox-item { display: flex; align-items: center; font-size: 0.85rem; font-family: 'Roboto', sans-serif; cursor: pointer; }
        .checkbox-item input { margin-right: 8px; transform: scale(1.1); cursor: pointer; }

        /* Action Area */
        .action-area { margin-bottom: 30px; }
        .config-row { display: flex; gap: 15px; margin-top: 15px; justify-content: flex-end; }

        .calc-button {
            display: block; width: 100%; padding: 16px;
            font-family: 'Roboto', sans-serif; font-size: 20px; font-weight: 700; color: #fff;
            background-color: #859f51; border: none; border-radius: 6px; cursor: pointer;
            transition: background-color 0.2s; box-shadow: 0 4px 0 #6b8041;
        }
        .calc-button:hover { background-color: #7c944d; }
        .calc-button:active { transform: translateY(2px); box-shadow: 0 2px 0 #6b8041; }

        .btn-config {
            padding: 10px 20px; font-size: 0.9rem;
            background-color: #e0d6c5; border: 1px solid #c9b7a2; border-radius: 4px;
            cursor: pointer; font-family: 'Roboto', sans-serif; font-weight: bold;
            color: #5a4030; transition: all 0.2s;
        }
        .btn-config:hover { background-color: #d3c5b0; border-color: #b09f8a; }

        /* --- TABLE --- */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-family: 'Roboto', sans-serif; font-size: 0.95rem; table-layout: fixed; }
        
        th { 
            background-color: var(--table-head-bg); color: #5a4030; font-weight: 700; 
            position: sticky; top: 0; text-align: left; padding: 12px 14px;
            border-bottom: 2px solid #dcd0c0;
        }

        .col-type { width: 18%; text-align: center; }      
        .col-action { width: 38%; }                        
        .col-prod { width: 12%; text-align: center; }      
        .col-status { width: 32%; }                        

        td { padding: 10px 14px; text-align: left; border-bottom: 1px solid #e0d6c5; vertical-align: middle; word-wrap: break-word; }
        tr:nth-child(even) { background-color: var(--row-alt); }
        tr:hover { background-color: #f0e6d6; }

        .badge {
            display: inline-block; padding: 5px 8px; border-radius: 4px; font-weight: bold;
            font-size: 0.65rem; min-width: 70px; text-align: center; text-transform: uppercase;
            border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.2); white-space: nowrap;
        }
        .theme-wood { background-color: #66bb6a; border-color: #388e3c; }
        .theme-clay { background-color: #ffa726; border-color: #f57c00; }
        .theme-iron { background-color: #9e9e9e; border-color: #616161; }
        .theme-crop { background-color: #fdd835; border-color: #fbc02d; color: #444; text-shadow: none; }
        .theme-special { background-color: #7e57c2; border-color: #512da8; }

        .prod-cell { text-align: center; font-weight: bold; color: #5a4030; font-family: 'Roboto', sans-serif; font-size: 1.05em; }
        .status-cell { font-size: 0.85em; color: #555; }

        /* Stats Box */
        .stats-box {
            background: white; padding: 20px; border-radius: 4px; border: 1px solid #ddd;
            margin-bottom: 20px; display: flex; justify-content: center; flex-wrap: wrap; gap: 40px; 
        }
        .stat-item { text-align: center; display: flex; flex-direction: column; align-items: center; }
        .stat-label { display: block; font-size: 0.85rem; color: #777; text-transform: uppercase; margin-bottom: 5px; font-family: 'Roboto', sans-serif; font-weight: bold; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary-text); }

        /* Visual Chips */
        .status-grid { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
        .res-chip {
            display: flex; align-items: center; font-family: 'Roboto', sans-serif; font-size: 0.75rem;
            background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 3px 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); white-space: nowrap;
        }
        .chip-wood { border-color: #81c784; background-color: #e8f5e9; color: #2e7d32; }
        .chip-clay { border-color: #ffb74d; background-color: #fff3e0; color: #ef6c00; }
        .chip-iron { border-color: #e0e0e0; background-color: #f5f5f5; color: #616161; }
        .chip-crop { border-color: #fff176; background-color: #fffde7; color: #f9a825; }
        .chip-spec { border-color: #b39ddb; background-color: #ede7f6; color: #512da8; }
        .chip-icon { margin-right: 4px; font-weight: normal; opacity: 1; font-size: 1rem; line-height: 1; }
        .chip-val  { font-weight: bold; margin-right: 4px; font-size: 0.85rem; }
        .fact-pills { display: flex; gap: 2px; margin-left: 3px; padding-left: 3px; border-left: 1px solid rgba(0,0,0,0.1); }
        .fact-pill { font-size: 0.7rem; padding: 1px 3px; border-radius: 3px; background: rgba(0,0,0,0.08); color: inherit; font-weight: bold; }

        /* Chart Container */
        .chart-container {
            background: white; border: 1px solid #ddd; border-radius: 4px;
            padding: 20px; height: 400px; position: relative;
        }

        .collapsible-header {
            background-color: var(--table-head-bg); padding: 15px;
            border: 1px solid var(--border-color); border-radius: 4px 4px 0 0;
            display: flex; align-items: center; justify-content: space-between;
            margin-top: 20px; font-weight: bold; color: #5a4030;
        }
        .collapsible-content { border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 4px 4px; background: #fff; }

        #scrollTopBtn {
            position: fixed; bottom: 25px; right: 25px; z-index: 999; border: none; outline: none;
            background-color: var(--accent-green); color: white; cursor: pointer; padding: 12px 16px;
            border-radius: 50%; font-size: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            transition: all 0.3s; opacity: 0; transform: translateY(20px); pointer-events: none;
        }
        #scrollTopBtn.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        #scrollTopBtn:hover { background-color: #6a8040; transform: translateY(-3px); }

        @media (max-width: 768px) {
            .controls-grid { grid-template-columns: 1fr; gap: 20px; }
            thead { display: none; } 
            table, tbody, tr, td { display: block; width: 100%; box-sizing: border-box; }
            tr { margin-bottom: 15px; background-color: #fff; border: 1px solid #e0d6c5; border-radius: 6px; padding: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            td.type-cell { border: none; padding: 0 0 8px 0; width: auto; text-align: left; }
            td.text-cell { border: none; padding: 8px 0; width: auto; font-size: 1.05rem; line-height: 1.4; border-top: 1px dashed #eee; }
            td.prod-cell { border: none; padding: 5px 0 10px 0; width: auto; text-align: left; font-size: 1.1rem; color: var(--accent-green); border-bottom: 1px solid #f0f0f0; }
            td.prod-cell::before { content: "Produzione: "; font-size: 0.8rem; color: #888; font-weight: normal; vertical-align: middle; }
            td.status-cell { border: none; padding: 10px 0 0 0; width: auto; display: block; }
            .status-grid { gap: 6px; }
            .res-chip { flex: 1; justify-content: center; }
        }
    </style>
</head>
<body>

<button onclick="window.scrollTo({top:0,behavior:'smooth'})" id="scrollTopBtn" title="Torna su">&#8679;</button>

<div class="container">

    <h1>Travian Planner 8.6</h1>
    
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="UI.setTab('calc')">üìù Pianificatore</div>
        <div class="nav-tab" onclick="UI.setTab('chart')">üìä Laboratorio Analisi</div>
    </div>

    <div id="view-calc" class="view-section active">
        <div id="main-controls-mount"></div>

        <div class="action-area">
            <button type="button" class="calc-button" onclick="UI.calculateMain()">Calcola Percorso Ottimale</button>
            <div class="config-row">
                <button class="btn-config" onclick="ConfigManager.download()">Scarica Config</button>
                <input type="file" id="uploadConfigInput" style="display:none" onchange="ConfigManager.upload(this)">
                <button class="btn-config" onclick="document.getElementById('uploadConfigInput').click()">Carica Config</button>
            </div>
        </div>

        <div id="results-area" style="display:none;">
            <div class="stats-box">
                <div class="stat-item">
                    <span class="stat-label">Produzione Oraria Totale</span>
                    <span class="stat-value" id="final-prod">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Costo Totale Risorse</span>
                    <span class="stat-value" id="final-cost">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Tempo di Recupero (ROI)</span>
                    <span class="stat-value" id="final-roi">0h</span>
                </div>
            </div>

            <div class="collapsible-header">Ordine di Sviluppo Ottimizzato</div>
            <div class="collapsible-content">
                <div class="table-responsive" id="output-grouped"></div>
            </div>
        </div>
    </div>

    <div id="view-chart" class="view-section">
        <p style="color:#666; font-size:0.9rem; margin-bottom:20px;">
            Confronta qui sotto diverse strategie o configurazioni.
        </p>
        
        <div class="chart-container">
            <canvas id="analysisChart"></canvas>
        </div>

        <div style="margin-top:30px;">
            <h3 style="color:#1e88e5; border-bottom:2px solid #1e88e5; padding-bottom:5px;">Scenario 2 (Blu)</h3>
            <div id="controls-b-mount"></div>
        </div>

        <div style="margin-top:30px;">
            <h3 style="color:#fb8c00; border-bottom:2px solid #fb8c00; padding-bottom:5px;">Scenario 3 (Arancio)</h3>
            <div id="controls-c-mount"></div>
        </div>
    </div>

</div>

<script>
/**
 * TRAVIAN CALCULATOR 8.6
 */

const GAME_DATA = {
    CONSTANTS: {
        MAX_FIELDS: 21,
        TRIBE_EGYPT_BONUS_FACTOR: 0.05, 
        FACTORY_BONUS: 0.05,            
        GOLD_BONUS_MULTIPLIER: 1.25,
        MAX_WAIT_TOLERANCE: 4.0
    },
    PREREQS: {
        sawmill:    { field: 'wood', level: 10, max: 5 },
        brickyard:  { field: 'clay', level: 10, max: 5 },
        foundry:    { field: 'iron', level: 10, max: 5 },
        mill:       { field: 'crop', level: 5,  max: 5 },
        bakery:     { field: 'crop', level: 10, max: 5, building: 'mill', buildingLvl: 5 },
        waterworks: { building: 'hm', buildingLvl: 10, max: 20, tribe: 'egyptian' }
    },
    COSTS: {
        mill: [0, 2560, 4605, 8295, 14925, 26875], 
        bakery: [0, 5150, 9270, 16690, 30035, 54060],
        sawmill: [0, 1280, 2300, 4145, 7465, 13440], 
        brickyard: [0, 1290, 2320, 4175, 7520, 13545], 
        foundry: [0, 1280, 2305, 4150, 7465, 13440], 
        hm: [0, 114240, 383295, 1595070], 
        waterworks: [0, 3105, 4065, 5325, 6980, 9145, 11975, 15695, 20555, 26925, 35280, 46215, 60545, 79310, 103895, 136105, 178300, 233560, 305965, 400815, 525070],
    },
    FIELDS: {
        prod: [3, 7, 13, 21, 31, 46, 70, 98, 140, 203, 280, 392, 525, 693, 889, 1120, 1400, 1820, 2240, 2800, 3430, 4270, 5250, 6440],
        costIron: [0, 270, 450, 755, 1260, 2100, 3510, 5855, 9785, 16335, 27275, 45555, 76075, 127045, 212170, 354325, 591710, 988160, 1650225, 2755880, 4602325, 7685870, 12835410, 21435125],
        costWood: [0, 250, 415, 695, 1165, 1945, 3250, 5425, 9060, 15125, 25255, 42180, 70440, 117630, 196450, 328075, 547880, 914965, 1527990, 2551745, 4261410, 7116550, 11884635, 19847340],
        costClay: [0, 250, 420, 700, 1170, 1940, 3250, 5425, 9060, 15125, 25250, 42185, 70440, 117635, 196450, 328075, 547875, 914970, 1527990, 2551740, 4261405, 7116550, 11884635, 19847345],
        costCrop: [0, 250, 415, 695, 1165, 1945, 3250, 5425, 9055, 15125, 25255, 42180, 70445, 117640, 196445, 328070, 547880, 914960, 1527985, 2551735, 4261410, 7116555, 11884640, 19847340]
    },
    TEMPLATES: {
        '00018': { w: 0, c: 0, i: 0, cr: 18 }, '11115': { w: 1, c: 1, i: 1, cr: 15 }, '3339':  { w: 3, c: 3, i: 3, cr: 9 },
        '4437':  { w: 4, c: 4, i: 3, cr: 7 }, '3447':  { w: 3, c: 4, i: 4, cr: 7 }, '4347':  { w: 4, c: 3, i: 4, cr: 7 },
        '3456':  { w: 3, c: 4, i: 5, cr: 6 }, '4446':  { w: 4, c: 4, i: 4, cr: 6 }, '4536':  { w: 4, c: 5, i: 3, cr: 6 },
        '5346':  { w: 5, c: 3, i: 4, cr: 6 }, '3546':  { w: 3, c: 5, i: 4, cr: 6 }, '4356':  { w: 4, c: 3, i: 5, cr: 6 },
        '5436':  { w: 5, c: 4, i: 3, cr: 6 }
    }
};

class TravianEngine {
    constructor(config) {
        this.config = config;
        this.state = this.getInitialState();
        this.baseProdCache = GAME_DATA.FIELDS.prod;
        this.currentTotalHourlyProd = 1; 
    }

    getInitialState() {
        const tpl = GAME_DATA.TEMPLATES[this.config.villageType] || GAME_DATA.TEMPLATES['4446'];
        return {
            wood: Array(tpl.w).fill(0), clay: Array(tpl.c).fill(0),
            iron: Array(tpl.i).fill(0), crop: Array(tpl.cr).fill(0),
            mill: 0, bakery: 0, sawmill: 0, brickyard: 0, foundry: 0,
            hm: 0, waterworks: 0, oasisActive: 0
        };
    }

    calculateProductionMetrics(state) {
        const getBase = (arr) => {
            let s = 0; for(let i=0; i<arr.length; i++) s += this.baseProdCache[arr[i]]; return s;
        };
        
        const wwBonus = (this.config.tribe === 'egyptian') ? (1 + state.waterworks * GAME_DATA.CONSTANTS.TRIBE_EGYPT_BONUS_FACTOR) : 1;
        
        let wOasis = 0, cOasis = 0, iOasis = 0, crOasis = 0;
        for(let k=0; k < state.oasisActive; k++) {
            const o = this.config.oases[k];
            if(o.wood) wOasis += o.wood; if(o.clay) cOasis += o.clay;
            if(o.iron) iOasis += o.iron; if(o.crop) crOasis += o.crop;
        }

        const goldMult = this.config.goldBonus;
        const factBonus = GAME_DATA.CONSTANTS.FACTORY_BONUS;

        // Produzione REALE
        const wReal = getBase(state.wood) * (1 + (state.sawmill * factBonus) + (wOasis * wwBonus)) * goldMult;
        const cReal = getBase(state.clay) * (1 + (state.brickyard * factBonus) + (cOasis * wwBonus)) * goldMult;
        const iReal = getBase(state.iron) * (1 + (state.foundry * factBonus) + (iOasis * wwBonus)) * goldMult;
        const crReal = getBase(state.crop) * (1 + (crOasis * wwBonus) + (state.mill * factBonus) + (state.bakery * factBonus)) * goldMult;
        
        const realTotal = wReal + cReal + iReal + crReal;

        // Produzione PESATA
        const weightedScore = (wReal * this.config.weights.wood) + 
                              (cReal * this.config.weights.clay) + 
                              (iReal * this.config.weights.iron) + 
                              (crReal * this.config.weights.crop);

        return { realTotal, weightedScore };
    }

    getFieldCost(type, lvl) {
        const F = GAME_DATA.FIELDS;
        return F.costWood[lvl] + F.costClay[lvl] + F.costIron[lvl] + F.costCrop[lvl];
    }

    evaluateChange(actionCallback, cost) {
        const metricsOld = this.calculateProductionMetrics(this.state);
        this.currentTotalHourlyProd = metricsOld.realTotal || 1; 

        // --- TIME PENALTY ---
        const hoursToAccumulate = cost / this.currentTotalHourlyProd;
        const limit = GAME_DATA.CONSTANTS.MAX_WAIT_TOLERANCE; 
        
        let waitingPenalty = 1.0;
        if (hoursToAccumulate > limit) {
            waitingPenalty = 1 + ((hoursToAccumulate - limit) * 0.15); 
        }
        const adjustedCost = cost * waitingPenalty;
        // --------------------

        const revertData = actionCallback(this.state, 'apply'); 
        const metricsNew = this.calculateProductionMetrics(this.state);
        
        const gain = metricsNew.weightedScore - metricsOld.weightedScore;

        actionCallback(this.state, 'revert', revertData);

        return (gain > 0.01) ? adjustedCost / gain : Infinity;
    }

    evaluateDependencyChain(buildingType) {
        const prereq = GAME_DATA.PREREQS[buildingType];
        if (!prereq) return null;

        const confKey = 'use' + buildingType.charAt(0).toUpperCase() + buildingType.slice(1);
        if (!this.config[confKey]) return null;

        const currentLvl = this.state[buildingType];
        if (currentLvl >= prereq.max) return null;

        let fieldCost = 0;
        if (prereq.field) {
            const fields = this.state[prereq.field];
            if (!fields.length) return null; 
            const maxLvl = Math.max(...fields);
            if (maxLvl < prereq.level) {
                for (let l = maxLvl + 1; l <= prereq.level; l++) {
                    fieldCost += this.getFieldCost(prereq.field, l);
                }
            }
        }

        if (prereq.building) {
            if (this.state[prereq.building] < prereq.buildingLvl) return null; 
        }

        const buildingCost = GAME_DATA.COSTS[buildingType][currentLvl + 1];
        const totalCost = fieldCost + buildingCost;

        const action = (s, mode, data) => {
            if (mode === 'apply') {
                let savedIdx = -1, savedLvl = -1;
                if (prereq.field) {
                    const maxLvl = Math.max(...s[prereq.field]);
                    if (maxLvl < prereq.level) {
                        savedIdx = s[prereq.field].indexOf(maxLvl);
                        savedLvl = maxLvl;
                        s[prereq.field][savedIdx] = prereq.level;
                    }
                }
                s[buildingType]++;
                return { idx: savedIdx, lvl: savedLvl };
            } else {
                s[buildingType]--;
                if (data.idx !== -1) {
                    s[prereq.field][data.idx] = data.lvl;
                }
            }
        };

        const roi = this.evaluateChange(action, totalCost);
        const isChain = fieldCost > 0;
        
        let desc = this.getName(buildingType);
        if (isChain) {
            const fieldName = this.getName(prereq.field);
            desc = `1 ${fieldName} al ${prereq.level} + ${desc} al ${currentLvl + 1}`;
        }

        return {
            type: buildingType, roi, cost: totalCost,
            desc: desc,
            lvl: currentLvl + 1, isChain: isChain, action: action
        };
    }

    getName(t) {
        const map = { 
            wood: 'Bosco', clay: 'Argilla', iron: 'Ferro', crop: 'Grano', 
            mill: 'Mulino', bakery: 'Forno', sawmill: 'Segheria', 
            brickyard: 'Fornace', 
            foundry: 'Fonderia', waterworks: 'Acquedotto' 
        };
        return map[t] || t;
    }

    runSimulation() {
        const steps = [];
        let totalSpent = 0;
        const MAX_ITERATIONS = 1500;
        const REAL_MAX = Math.min(this.config.maxLevel, GAME_DATA.CONSTANTS.MAX_FIELDS);

        this.calculateProductionMetrics(this.state); 

        for(let i=0; i<MAX_ITERATIONS; i++) {
            let bestOption = { roi: Infinity };

            // 1. Fields
            ['wood', 'clay', 'iron', 'crop'].forEach(res => {
                const arr = this.state[res];
                if (!arr.length) return;
                const minLvl = Math.min(...arr);
                if (minLvl >= REAL_MAX) return;

                const cost = this.getFieldCost(res, minLvl+1);
                const roi = this.evaluateChange((s, mode, data) => {
                    if(mode==='apply') {
                        const idx = s[res].indexOf(minLvl);
                        s[res][idx]++;
                        return idx;
                    } else {
                        s[res][data]--;
                    }
                }, cost);

                if (roi < bestOption.roi) bestOption = { type: 'field', res, roi, cost, lvl: minLvl+1, desc: this.getName(res) };
            });

            // 2. Buildings
            ['sawmill', 'brickyard', 'foundry', 'mill', 'bakery', 'waterworks'].forEach(b => {
                const opt = this.evaluateDependencyChain(b);
                if (opt && opt.roi < bestOption.roi) bestOption = opt;
            });

            // 3. Oases
            if (this.state.oasisActive < 3) {
                const nextOasis = this.config.oases[this.state.oasisActive];
                if (nextOasis && Object.keys(nextOasis).length > 0) {
                    const reqHM = [10, 15, 20][this.state.oasisActive];
                    const cost = GAME_DATA.COSTS.hm[this.state.oasisActive + 1];
                    
                    const action = (s, mode) => {
                        if(mode==='apply') { s.oasisActive++; s.hm = reqHM; }
                        else { s.oasisActive--; s.hm = (s.oasisActive===0?0:[10,15,20][s.oasisActive-1]); }
                    };
                    
                    const roi = this.evaluateChange(action, cost);
                    if (roi < bestOption.roi) bestOption = { type: 'oasis', roi, cost, lvl: reqHM, desc: 'Oasi (Dimora)', action };
                }
            }

            if (bestOption.roi === Infinity) break;

            // Execute
            totalSpent += bestOption.cost;
            if (bestOption.type === 'field') {
                const arr = this.state[bestOption.res];
                const idx = arr.indexOf(Math.min(...arr));
                this.state[bestOption.res][idx]++;
            } else if (bestOption.action) {
                bestOption.action(this.state, 'apply');
            }

            const metrics = this.calculateProductionMetrics(this.state);
            const displayProd = Math.round(metrics.realTotal);

            steps.push({
                step: i + 1,
                desc: bestOption.desc,
                type: bestOption.type === 'field' ? bestOption.res : bestOption.type,
                lvl: bestOption.lvl,
                rush: bestOption.isChain,
                prod: displayProd,
                cost: bestOption.cost,
                totalSpent: totalSpent,
                stateStr: this.getStateHTML(this.state)
            });
        }

        return { steps, totalSpent };
    }

    getStateHTML(s) {
        const getDetailedLvl = (arr) => {
            if(!arr.length) return "0";
            const counts = {};
            arr.forEach(l => counts[l] = (counts[l] || 0) + 1);
            return Object.entries(counts).sort((a,b) => b[0] - a[0])
                .map(([lvl, num]) => `${num}x${lvl}`).join(' ');
        };
        let html = '<div class="status-grid">';
        if (s.wood.length) html += `<div class="res-chip chip-wood"><span class="chip-icon">üå≤</span><span class="chip-val">${getDetailedLvl(s.wood)}</span>${s.sawmill ? `<div class="fact-pills"><span class="fact-pill">S${s.sawmill}</span></div>` : ''}</div>`;
        if (s.clay.length) html += `<div class="res-chip chip-clay"><span class="chip-icon">üß±</span><span class="chip-val">${getDetailedLvl(s.clay)}</span>${s.brickyard ? `<div class="fact-pills"><span class="fact-pill">M${s.brickyard}</span></div>` : ''}</div>`;
        if (s.iron.length) html += `<div class="res-chip chip-iron"><span class="chip-icon">‚öíÔ∏è</span><span class="chip-val">${getDetailedLvl(s.iron)}</span>${s.foundry ? `<div class="fact-pills"><span class="fact-pill">F${s.foundry}</span></div>` : ''}</div>`;
        if (s.crop.length) {
            let facts = []; if(s.mill) facts.push(`M${s.mill}`); if(s.bakery) facts.push(`F${s.bakery}`);
            html += `<div class="res-chip chip-crop"><span class="chip-icon">üåæ</span><span class="chip-val">${getDetailedLvl(s.crop)}</span>${facts.length ? `<div class="fact-pills">${facts.map(f=>`<span class="fact-pill">${f}</span>`).join('')}</div>` : ''}</div>`;
        }
        let specials = [];
        if(s.oasisActive > 0) specials.push(`üèùÔ∏èx${s.oasisActive}`);
        if(s.waterworks > 0) specials.push(`AQ${s.waterworks}`);
        if (specials.length) html += `<div class="res-chip chip-spec"><span class="chip-val">${specials.join(' ')}</span></div>`;
        html += '</div>';
        return html;
    }
}

const UI = {
    configs: {
        A: { villageType: '4446', tribe: 'generic', goldBonus: 1.25, maxLevel: 19, oases: [{}, {}, {}], weights: { wood: 1, clay: 1, iron: 1, crop: 1 }, useSawmill: true, useBrickyard: true, useFoundry: true, useMill: true, useBakery: true, useWaterworks: true },
        B: { villageType: '4446', tribe: 'generic', goldBonus: 1.25, maxLevel: 19, oases: [{}, {}, {}], weights: { wood: 1, clay: 1, iron: 1, crop: 1 }, useSawmill: true, useBrickyard: true, useFoundry: true, useMill: true, useBakery: true, useWaterworks: true },
        C: { villageType: '4446', tribe: 'generic', goldBonus: 1.25, maxLevel: 19, oases: [{}, {}, {}], weights: { wood: 1, clay: 1, iron: 1, crop: 1 }, useSawmill: true, useBrickyard: true, useFoundry: true, useMill: true, useBakery: true, useWaterworks: true }
    },
    chartInstance: null,

    init: function() {
        this.renderAllControls();
        window.onscroll = function() {
            const btn = document.getElementById("scrollTopBtn");
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) { btn.classList.add("show"); } else { btn.classList.remove("show"); }
        };
    },

    setTab: function(view) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
        
        document.getElementById('view-' + view).classList.add('active');
        if(view === 'calc') document.querySelectorAll('.nav-tab')[0].classList.add('active');
        else document.querySelectorAll('.nav-tab')[1].classList.add('active');

        if(view === 'chart') this.updateChart();
    },

    renderControlsHTML: function(variant) {
        const c = this.configs[variant];
        return `
        <div class="controls-grid">
            <div class="control-section var-${variant.toLowerCase()}">
                <h3 class="section-title">Parametri Base (${variant})</h3>
                <div class="control-group">
                    <label>Layout Villaggio</label>
                    <select onchange="UI.update('${variant}', 'villageType', this.value)">
                        <option value="11115" ${c.villageType=='11115'?'selected':''}>1-1-1-15 (15 Grani)</option>
                        <option value="3339" ${c.villageType=='3339'?'selected':''}>3-3-3-9 (9 Grani)</option>
                        <option value="4437" ${c.villageType=='4437'?'selected':''}>4-4-3-7 (7 Grani)</option>
                        <option value="3447" ${c.villageType=='3447'?'selected':''}>3-4-4-7 (7 Grani)</option>
                        <option value="4347" ${c.villageType=='4347'?'selected':''}>4-3-4-7 (7 Grani)</option>
                        <option value="4446" ${c.villageType=='4446'?'selected':''}>4-4-4-6 (6 Grani)</option>
                        <option value="3456" ${c.villageType=='3456'?'selected':''}>3-4-5-6 (6 Grani)</option>
                        <option value="4536" ${c.villageType=='4536'?'selected':''}>4-5-3-6 (6 Grani)</option>
                        <option value="5346" ${c.villageType=='5346'?'selected':''}>5-3-4-6 (6 Grani)</option>
                        <option value="3546" ${c.villageType=='3546'?'selected':''}>3-5-4-6 (6 Grani)</option>
                        <option value="4356" ${c.villageType=='4356'?'selected':''}>4-3-5-6 (6 Grani)</option>
                        <option value="5436" ${c.villageType=='5436'?'selected':''}>5-4-3-6 (6 Grani)</option>
                        <option value="00018" ${c.villageType=='00018'?'selected':''}>0-0-0-18 (18 Grani)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Max Livello Campi</label>
                    <div class="range-wrapper">
                        <input type="range" min="1" max="21" value="${c.maxLevel}" oninput="this.nextElementSibling.innerText=this.value; UI.update('${variant}', 'maxLevel', this.value); UI.autoUpdateChart();">
                        <span class="range-value">${c.maxLevel}</span>
                    </div>
                </div>
                <div class="control-group">
                    <label>Trib√π</label>
                    <select onchange="UI.update('${variant}', 'tribe', this.value); UI.autoUpdateChart();">
                        <option value="generic" ${c.tribe=='generic'?'selected':''}>Standard (Romani/Galli/Teutoni)</option>
                        <option value="egyptian" ${c.tribe=='egyptian'?'selected':''}>Egizi (Bonus Acquedotto)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Bonus Gold (+25%)</label>
                    <select onchange="UI.update('${variant}', 'goldBonus', this.value); UI.autoUpdateChart();">
                        <option value="1.25" ${c.goldBonus==1.25?'selected':''}>Attivo</option>
                        <option value="1" ${c.goldBonus==1?'selected':''}>Disattivato</option>
                    </select>
                </div>
            </div>

            <div class="control-section var-${variant.toLowerCase()}">
                <h3 class="section-title">Confronta Strategie</h3>
                <p style="font-size:0.75rem; color:#666; margin-bottom:10px;">Modifica i pesi per simulare carenze di risorse specifiche.</p>
                <div class="weights-row">
                    <div class="weight-item">
                        <label>Legno</label>
                        <input type="range" min="0" max="2" step="0.1" value="${c.weights.wood}" oninput="this.nextElementSibling.innerText=this.value; UI.updateWeight('${variant}', 'wood', this.value);">
                        <span class="weight-val">${c.weights.wood}</span>
                    </div>
                    <div class="weight-item">
                        <label>Argilla</label>
                        <input type="range" min="0" max="2" step="0.1" value="${c.weights.clay}" oninput="this.nextElementSibling.innerText=this.value; UI.updateWeight('${variant}', 'clay', this.value);">
                        <span class="weight-val">${c.weights.clay}</span>
                    </div>
                    <div class="weight-item">
                        <label>Ferro</label>
                        <input type="range" min="0" max="2" step="0.1" value="${c.weights.iron}" oninput="this.nextElementSibling.innerText=this.value; UI.updateWeight('${variant}', 'iron', this.value);">
                        <span class="weight-val">${c.weights.iron}</span>
                    </div>
                    <div class="weight-item">
                        <label>Grano</label>
                        <input type="range" min="0" max="2" step="0.1" value="${c.weights.crop}" oninput="this.nextElementSibling.innerText=this.value; UI.updateWeight('${variant}', 'crop', this.value);">
                        <span class="weight-val">${c.weights.crop}</span>
                    </div>
                </div>
                <h3 class="section-title" style="margin-top:15px;">Edifici Abilitati</h3>
                <div class="checkbox-grid">
                    <label class="checkbox-item"><input type="checkbox" ${c.useSawmill?'checked':''} onchange="UI.update('${variant}', 'useSawmill', this.checked); UI.autoUpdateChart();"> Segheria</label>
                    <label class="checkbox-item"><input type="checkbox" ${c.useBrickyard?'checked':''} onchange="UI.update('${variant}', 'useBrickyard', this.checked); UI.autoUpdateChart();"> Fornace</label>
                    <label class="checkbox-item"><input type="checkbox" ${c.useFoundry?'checked':''} onchange="UI.update('${variant}', 'useFoundry', this.checked); UI.autoUpdateChart();"> Fonderia</label>
                    <label class="checkbox-item"><input type="checkbox" ${c.useMill?'checked':''} onchange="UI.update('${variant}', 'useMill', this.checked); UI.autoUpdateChart();"> Mulino</label>
                    <label class="checkbox-item"><input type="checkbox" ${c.useBakery?'checked':''} onchange="UI.update('${variant}', 'useBakery', this.checked); UI.autoUpdateChart();"> Forno</label>
                    <label class="checkbox-item"><input type="checkbox" ${c.useWaterworks?'checked':''} onchange="UI.update('${variant}', 'useWaterworks', this.checked); UI.autoUpdateChart();"> Acquedotto</label>
                </div>
            </div>

            <div class="control-section var-${variant.toLowerCase()}">
                <h3 class="section-title">Oasi Conquistabili</h3>
                ${[0,1,2].map(i => `
                <div class="control-group">
                    <label>Oasi ${i+1}</label>
                    <select onchange="UI.updateOasis('${variant}', ${i}, this.value); UI.autoUpdateChart();">
                        <option value="none">Nessuna</option>
                        <option value="crop-25">üåæ Grano 25%</option>
                        <option value="crop-50">üåæ Grano 50%</option>
                        <option value="wood-25">üå≤ Legno 25%</option>
                        <option value="wood-50">üå≤ Legno 50%</option>
                        <option value="wood-25_crop-25">üå≤ Legno 25% + üåæ Grano 25%</option>
                        <option value="clay-25">üß± Argilla 25%</option>
                        <option value="clay-50">üß± Argilla 50%</option>
                        <option value="clay-25_crop-25">üß± Argilla 25% + üåæ Grano 25%</option>
                        <option value="iron-25">‚öíÔ∏è Ferro 25%</option>
                        <option value="iron-50">‚öíÔ∏è Ferro 50%</option>
                        <option value="iron-25_crop-25">‚öíÔ∏è Ferro 25% + üåæ Grano 25%</option>
                    </select>
                </div>`).join('')}
            </div>
        </div>`;
    },

    renderAllControls: function() {
        document.getElementById('main-controls-mount').innerHTML = this.renderControlsHTML('A');
        document.getElementById('controls-b-mount').innerHTML = this.renderControlsHTML('B');
        document.getElementById('controls-c-mount').innerHTML = this.renderControlsHTML('C');
        this.syncSelects('A'); this.syncSelects('B'); this.syncSelects('C');
    },

    update: function(variant, key, val) {
        if(val === 'true') val = true; if(val === 'false') val = false;
        if (key === 'maxLevel') val = parseInt(val); if (key === 'goldBonus') val = parseFloat(val);
        this.configs[variant][key] = val;
    },

    updateWeight: function(variant, res, val) {
        this.configs[variant].weights[res] = parseFloat(val);
        this.autoUpdateChart();
    },

    updateOasis: function(variant, idx, str) {
        const o = {};
        if (str !== 'none') {
            str.split('_').forEach(seg => {
                const parts = seg.split('-');
                o[parts[0]] = parseFloat(parts[1]) / 100.0;
            });
        }
        this.configs[variant].oases[idx] = o;
    },

    syncSelects: function(v) {
        const oases = this.configs[v].oases;
        const container = document.querySelector(`.var-${v.toLowerCase()}`).parentElement; 
        const selects = container.querySelectorAll('select');
        const len = selects.length;
        [0,1,2].forEach(i => {
            const sel = selects[len-3+i];
            const o = oases[i];
            let val = 'none';
            let parts = [];
            if(o.wood) parts.push(`wood-${o.wood*100}`);
            if(o.clay) parts.push(`clay-${o.clay*100}`);
            if(o.iron) parts.push(`iron-${o.iron*100}`);
            if(o.crop) parts.push(`crop-${o.crop*100}`);
            if(parts.length) val = parts.join('_');
            sel.value = val;
        });
    },

    autoUpdateChart: function() {
        if(document.getElementById('view-chart').classList.contains('active')) {
            this.updateChart();
        }
    },

    calculateMain: function() {
        try {
            const engine = new TravianEngine(this.configs.A);
            const result = engine.runSimulation();
            this.renderTable(result);
            this.updateChart(); 
        } catch(e) { console.error(e); alert("Errore nel calcolo: " + e.message); }
    },

    updateChart: function() {
        const resA = (new TravianEngine(this.configs.A)).runSimulation();
        const resB = (new TravianEngine(this.configs.B)).runSimulation();
        const resC = (new TravianEngine(this.configs.C)).runSimulation();
        this.renderChartCanvas(resA.steps, resB.steps, resC.steps);
    },

    escapeHtml: function(text) {
        if (!text) return text;
        return text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    },

    renderTable: function(res) {
        const area = document.getElementById('results-area');
        area.style.display = 'block';
        const steps = res.steps;
        
        if(steps.length > 0) {
            const last = steps[steps.length-1];
            document.getElementById('final-prod').innerText = last.prod.toLocaleString();
            document.getElementById('final-cost').innerText = res.totalSpent.toLocaleString();
            
            let roi = 0;
            if (last.prod > 0) roi = Math.round(res.totalSpent / last.prod);
            document.getElementById('final-roi').innerText = roi.toLocaleString() + " ore";
        }

        const container = document.getElementById('output-grouped');
        container.innerHTML = ''; 
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        // FIX: Cambiato etichetta da Prod. REALE a Produzione Oraria
        thead.innerHTML = `<tr><th class="col-type">Tipo</th><th class="col-action">Azione</th><th class="col-prod">Prod. Oraria</th><th class="col-status">Stato Villaggio</th></tr>`;
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        const fragment = document.createDocumentFragment();

        if(steps.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="4" style="text-align:center; padding: 20px;">Nessun upgrade possibile.</td>';
            fragment.appendChild(tr);
        } else {
            let grp = { ...steps[0], count: 1 };
            
            const flushGroup = (g) => {
                let theme = 'theme-special';
                if (['wood','sawmill'].includes(g.type)) theme = 'theme-wood';
                else if (['clay','brickyard'].includes(g.type)) theme = 'theme-clay';
                else if (['iron','foundry'].includes(g.type)) theme = 'theme-iron';
                else if (['crop','mill','bakery'].includes(g.type)) theme = 'theme-crop';

                let label = this.escapeHtml(g.desc);
                const mapName = {
                    sawmill: 'SEGHERIA', brickyard: 'FORNACE', foundry: 'FONDERIA',
                    wood: 'LEGNO', clay: 'ARGILLA', iron: 'FERRO', crop: 'GRANO',
                    mill: 'MULINO', bakery: 'FORNO', waterworks: 'ACQUEDOTTO', oasis: 'DIMORA EROE'
                };
                let badgeText = mapName[g.type] || g.type.toUpperCase();
                
                let actionText = "";
                if(g.rush) {
                    actionText = `<b>${g.desc}</b>`; 
                }
                else if(g.type === 'oasis') actionText = `Conquista Oasi`;
                else {
                    let name = label;
                    if(['wood','clay','iron','crop'].includes(g.type)) name = mapName[g.type];
                    actionText = `Porta <b>${g.count}</b> ${name} al livello <b>${g.lvl}</b>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="type-cell"><span class="badge ${theme}">${badgeText}</span></td>
                    <td class="text-cell">${actionText}</td>
                    <td class="prod-cell">${g.prod.toLocaleString()}</td>
                    <td class="status-cell col-status">${g.stateStr}</td>
                `;
                fragment.appendChild(tr);
            };

            for(let i=1; i<steps.length; i++) {
                const s = steps[i];
                if (s.type === grp.type && s.lvl === grp.lvl && s.rush === grp.rush && !s.rush) {
                    grp.count++;
                    grp.prod = s.prod;
                    grp.stateStr = s.stateStr;
                } else {
                    flushGroup(grp);
                    grp = { ...s, count: 1 };
                }
            }
            flushGroup(grp);
        }
        tbody.appendChild(fragment);
        table.appendChild(tbody);
        container.appendChild(table);
    },

    renderChartCanvas: function(stepsA, stepsB, stepsC) {
        const ctx = document.getElementById('analysisChart').getContext('2d');
        if (this.chartInstance) this.chartInstance.destroy();

        const allSteps = [stepsA, stepsB, stepsC];
        const maxSpent = Math.max(...allSteps.map(s => s.length ? s[s.length-1].totalSpent : 0));

        const getPoints = (steps) => {
            let data = steps.map(s => ({ x: s.totalSpent, y: s.prod }));
            
            if (data.length > 80) {
                const mod = Math.ceil(data.length / 80);
                data = data.filter((_, i) => i % mod === 0 || i === data.length - 1);
            }

            // FIX: Line extension for comparison
            if (data.length > 0) {
                const last = data[data.length - 1];
                if (last.x < maxSpent) {
                    data.push({ x: maxSpent, y: last.y });
                }
            }

            return data;
        };

        this.chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Scenario A (Verde)',
                        data: getPoints(stepsA),
                        borderColor: '#859f51',
                        backgroundColor: 'rgba(133, 159, 81, 0.1)',
                        fill: true, tension: 0.3, pointRadius: 0, borderWidth: 3
                    },
                    {
                        label: 'Scenario B (Blu)',
                        data: getPoints(stepsB),
                        borderColor: '#1e88e5',
                        backgroundColor: 'transparent',
                        fill: false, tension: 0.3, pointRadius: 0, borderWidth: 3
                    },
                    {
                        label: 'Scenario C (Arancio)',
                        data: getPoints(stepsC),
                        borderColor: '#fb8c00',
                        backgroundColor: 'transparent',
                        fill: false, tension: 0.3, pointRadius: 0, borderWidth: 3
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: { intersect: false, callbacks: { label: (context) => context.dataset.label + ": " + context.formattedValue + " /h" } },
                    title: { display: false }
                },
                scales: {
                    x: { type: 'linear', display: true, title: {display: true, text: 'Risorse Totali Investite'}, ticks: { callback: function(value) { return value >= 1000000 ? (value/1000000).toFixed(1) + 'M' : (value/1000).toFixed(0) + 'k'; } } },
                    // FIX: Etichetta asse Y cambiata in 'Produzione Oraria'
                    y: { beginAtZero: true, grid: { color: '#f0f0f0' }, title: { display: true, text: 'Produzione Oraria' } }
                }
            }
        });
    }
};

const ConfigManager = {
    download: function() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(UI.configs));
        dlAnchorElem.setAttribute("href", dataStr);
        dlAnchorElem.setAttribute("download", "travian_config_8.6.json");
        dlAnchorElem.click();
    },
    upload: function(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                if(data.A && data.B && data.C) UI.configs = data;
                else { UI.configs.A = {...data}; UI.configs.B = {...data}; UI.configs.C = {...data}; }
                UI.renderAllControls();
                alert("Configurazione caricata!");
            } catch (err) { alert("Errore file."); console.error(err); }
        };
        reader.readAsText(file);
        input.value = '';
    }
};

window.onload = function() { 
    UI.configs.B = JSON.parse(JSON.stringify(UI.configs.A));
    UI.configs.C = JSON.parse(JSON.stringify(UI.configs.A));
    UI.init(); 
}
</script>
</body>
</html>
